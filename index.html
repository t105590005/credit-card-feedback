<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿¡ç”¨å¡å›é¥‹åŠ©æ‰‹</title>
    <style>
        :root {
            --bg: #f8f9ff; --card-bg: #ffffff;
            --primary: #5f27cd; --primary-light: #9980FA;
            --success: #1dd1a1; --warning: #ff9f43; --danger: #ee5253;
            --text-dark: #341f97; --text-card: #5f27cd;
            --note-bg: #f3f0ff; --note-text: #5f27cd;
            --limit-bg: #e6fffa; --limit-text: #00b894;
        }

        body { 
            font-family: -apple-system, "Noto Sans TC", sans-serif; 
            background-color: var(--bg); color: var(--text-dark);
            margin: 0; padding: 16px; -webkit-tap-highlight-color: transparent;
        }

        .container { max-width: 480px; margin: 0 auto; padding-bottom: 120px; }

        /* å„€è¡¨æ¿ */
        .dashboard {
            background: linear-gradient(135deg, #5f27cd 0%, #341f97 100%);
            border-radius: 28px; padding: 25px; color: white;
            box-shadow: 0 12px 30px rgba(95, 39, 205, 0.3);
            margin-bottom: 25px; display: flex; justify-content: space-around;
        }
        .stat-value { font-size: 1.6em; font-weight: 800; }

        /* é€šè·¯å¡ç‰‡ */
        .category-card {
            background: var(--card-bg); border-radius: 26px; margin-bottom: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.05); border: 1px solid rgba(95, 39, 205, 0.08);
            overflow: hidden;
        }
        .category-head { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .category-name { font-weight: 800; font-size: 1.2em; color: var(--text-dark); }
        .category-badge { font-size: 0.75em; color: var(--primary); background: var(--note-bg); padding: 4px 10px; border-radius: 20px; font-weight: 700; margin-top: 4px; display: inline-block; }

        /* ç¸®å°å¾Œçš„æ–°å¢å¡ç‰‡æŒ‰éˆ• */
        .btn-small-add {
            background: none; border: 1px solid #e2e8f0; color: #94a3b8;
            padding: 4px 10px; border-radius: 8px; font-size: 0.75em; font-weight: 700;
        }

        .card-list { display: block; }
        .card-list.collapsed { display: none; }
        .card-item { padding: 20px; border-top: 1px solid #f8f9ff; }

        /* æ¨™ç±¤ä½µæ’æ’ç‰ˆ */
        .card-header-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .card-title { font-weight: 800; font-size: 1.15em; color: var(--text-card); margin-bottom: 8px; cursor: pointer; }
        
        .label-group { display: flex; flex-direction: row; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        .pill {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 5px 10px; border-radius: 10px; font-size: 0.78em; font-weight: 700;
            white-space: nowrap;
        }
        .pill-note { background: var(--note-bg); color: var(--note-text); border: 1px solid #e0d9ff; cursor: pointer; }
        .pill-limit { background: var(--limit-bg); color: var(--limit-text); border: 1px solid #c6f6d5; }

        .btn-record { 
            background: var(--primary); color: white; border: none; padding: 8px 16px; 
            border-radius: 12px; font-weight: 800; font-size: 0.9em; 
            box-shadow: 0 4px 12px rgba(95, 39, 205, 0.2); cursor: pointer;
        }

        /* é€²åº¦æ¢ */
        .progress-box { background: #f1f5f9; height: 12px; border-radius: 10px; margin: 12px 0; cursor: pointer; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 0.8s ease; }
        .bg-green { background: linear-gradient(90deg, #1dd1a1, #00d2d3); }
        .bg-orange { background: linear-gradient(90deg, #ff9f43, #ff6b6b); }
        .bg-red { background: linear-gradient(90deg, #ee5253, #ff4757); }

        .card-footer { display: flex; justify-content: space-between; font-size: 0.8em; color: #94a3b8; font-weight: 600; }
        .clickable { color: var(--primary-light); text-decoration: underline; cursor: pointer; }

        /* åº•éƒ¨å·¥å…· */
        .admin-tools { display: flex; gap: 10px; margin-top: 30px; }
        .btn-tool { flex: 1; padding: 14px; border-radius: 18px; border: 1.5px solid #e2e8f0; background: white; font-weight: 800; color: #64748b; cursor: pointer; font-size: 0.85em; }

        /* å½ˆçª— */
        #modalOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(52, 31, 151, 0.4); backdrop-filter: blur(6px); z-index: 999; align-items: flex-end; justify-content: center; }
        .modal-body { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 30px 30px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .input-box { width: 100%; padding: 14px; border: 2px solid #f1f5f9; border-radius: 14px; font-size: 16px; box-sizing: border-box; background: #f8fafc; outline: none; margin: 8px 0; }
        .modal-btns { display: flex; gap: 12px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="dashboard">
        <div style="text-align: center;">
            <span style="font-size: 0.8em; opacity: 0.8; display: block; margin-bottom: 4px;">æœ¬æœˆç¸½æ¶ˆè²»</span>
            <div class="stat-value" id="globalTotalSpent">$0</div>
        </div>
        <div style="text-align: center;">
            <span style="font-size: 0.8em; opacity: 0.8; display: block; margin-bottom: 4px;">é è¨ˆç¸½å›é¥‹</span>
            <div class="stat-value" style="color: #ffd166" id="globalTotalReward">$0</div>
        </div>
    </div>

    <button onclick="showAddCat()" style="width: 100%; padding: 18px; border-radius: 20px; border: none; background: white; color: var(--primary); font-weight: 900; font-size: 1em; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 20px; cursor: pointer;">
        âœ¨ æ–°å¢é€šè·¯åˆ†é¡
    </button>

    <div id="mainDisplay"></div>

    <div class="admin-tools">
        <button class="btn-tool" onclick="exportData()">ğŸ“¤ å‚™ä»½</button>
        <button class="btn-tool" onclick="document.getElementById('fileInput').click()">ğŸ“¥ åŒ¯å…¥</button>
        <button class="btn-tool" style="color: var(--danger); border-color: #ffccd5;" onclick="resetAll()">ğŸ§¹ æ­¸é›¶</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(event)" accept=".json">
    </div>
</div>

<div id="modalOverlay"><div class="modal-body" id="modalBox"></div></div>

<script>
    const STORAGE_KEY = 'cardTracker_2026_compact_UI';
    let data = [];

    function load() {
        try {
            let saved = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            data = migrate(saved);
            render();
        } catch(e) { data = []; render(); }
    }

    function migrate(list) {
        return list.map(cat => ({
            ...cat,
            cards: cat.cards.map(card => {
                if (!card.tiers) return { ...card, tiers: [{ rate: card.rate || 0, limit: card.limit || 0 }] };
                return card;
            })
        }));
    }

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); render(); }
    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

    function toggleCategory(id) {
        const cat = data.find(c => c.id === id);
        if (cat) { cat.isCollapsed = !cat.isCollapsed; save(); }
    }

    function render() {
        const container = document.getElementById('mainDisplay');
        container.innerHTML = '';
        let gSpent = {};
        data.forEach(cat => cat.cards.forEach(card => {
            const n = card.name.trim();
            gSpent[n] = (gSpent[n] || 0) + (card.spent || 0);
        }));

        data.forEach(cat => {
            let catHtml = "", catTotal = 0;
            cat.cards.forEach(card => {
                const totalS = gSpent[card.name.trim()];
                catTotal += (card.spent || 0);
                
                let minCap = 9999999;
                card.tiers.forEach(t => {
                    if (t.limit < 999999) {
                        const cap = Math.round(t.limit / (t.rate / 100));
                        if (cap < minCap) minCap = cap;
                    }
                });
                
                const pct = Math.min((totalS / minCap) * 100, 100);
                const rem = Math.max(0, minCap - totalS);
                let col = "bg-green"; if(pct>=100) col="bg-red"; else if(pct>=80) col="bg-orange";

                catHtml += `
                <div class="card-item">
                    <div class="card-header-row">
                        <div onclick="showEdit(${cat.id}, ${card.id}, 'name')">
                            <div class="card-title">${card.name}</div>
                            <div class="label-group">
                                <div class="pill pill-note" onclick="event.stopPropagation(); showEdit(${cat.id}, ${card.id}, 'note')">
                                    ğŸ“ ${card.note || 'ç„¡å‚™è¨»'}
                                </div>
                                <div class="pill pill-limit">
                                    ğŸ’° å‰©é¤˜ $${rem.toLocaleString()}
                                </div>
                            </div>
                        </div>
                        <button class="btn-record" onclick="showRecord(${cat.id}, ${card.id})">ï¼‹ç´€éŒ„</button>
                    </div>
                    <div class="progress-box" onclick="showRewardDetail('${card.name}')">
                        <div class="progress-fill ${col}" style="width: ${pct}%"></div>
                    </div>
                    <div class="card-footer">
                        <span>ç¸½åˆ·: <b>$${totalS.toLocaleString()}</b> (æ­¤åœ°: <span class="clickable" onclick="showEdit(${cat.id}, ${card.id}, 'spent')">$${(card.spent||0).toLocaleString()}</span>)</span>
                        <span class="clickable" onclick="showEdit(${cat.id}, ${card.id}, 'tiers')">${card.tiers.length}å±¤è¦å‰‡ âš™ï¸</span>
                    </div>
                </div>`;
            });

            container.innerHTML += `
            <div class="category-card">
                <div class="category-head" onclick="toggleCategory(${cat.id})">
                    <div style="display:flex; flex-direction:column;">
                        <div class="category-name"><span>${cat.isCollapsed ? 'â–¶' : 'â–¼'}</span> ${cat.name}</div>
                        <div class="category-badge">å°è¨ˆï¼š$${catTotal.toLocaleString()}</div>
                    </div>
                    <button class="btn-small-add" onclick="event.stopPropagation(); showAddCard(${cat.id})">ï¼‹å¡ç‰‡</button>
                </div>
                <div class="card-list ${cat.isCollapsed ? 'collapsed' : ''}">${catHtml || '<div style="padding:30px;text-align:center;color:#cbd5e1;font-size:0.9em;">é»æ“Šã€Œï¼‹å¡ç‰‡ã€é–‹å§‹</div>'}</div>
            </div>`;
        });

        // ç¸½å›é¥‹è¨ˆç®—
        let totalS = 0, totalR = 0, done = {};
        data.forEach(cat => cat.cards.forEach(card => {
            totalS += (card.spent || 0);
            const n = card.name.trim();
            if (!done[n]) {
                card.tiers.forEach(t => { totalR += Math.floor(Math.min(gSpent[n] * (t.rate / 100), t.limit)); });
                done[n] = true;
            }
        }));
        document.getElementById('globalTotalSpent').innerText = '$' + totalS.toLocaleString();
        document.getElementById('globalTotalReward').innerText = '$' + totalR.toLocaleString();
    }

    // --- äº’å‹•åŠŸèƒ½ (ç²¾ç°¡ç‰ˆ) ---
    function showAddCat() {
        const modal = document.getElementById('modalOverlay');
        document.getElementById('modalBox').innerHTML = `<h3>ğŸ’œ æ–°å¢åˆ†é¡</h3><input type="text" id="catN" class="input-box" placeholder="é€šè·¯åç¨±">
        <div class="modal-btns"><button class="btn-tool" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-record" style="flex:2" onclick="doAddCat()">å»ºç«‹</button></div>`;
        modal.style.display = 'flex';
    }
    function doAddCat() { const n = document.getElementById('catN').value.trim(); if(n) { data.push({id: Date.now(), name: n, cards: [], isCollapsed: false}); save(); closeModal(); } }

    function addTierUI(r="", l="") {
        const div = document.createElement('div'); div.style.display="flex"; div.style.gap="8px"; div.style.marginBottom="8px";
        div.innerHTML = `<input type="number" class="input-box t-r" placeholder="%" style="flex:1" value="${r}"><input type="number" class="input-box t-l" placeholder="ä¸Šé™" style="flex:2" value="${l}"><button onclick="this.parentElement.remove()" style="border:none;background:none;color:var(--danger)">âœ•</button>`;
        document.getElementById('tCon').appendChild(div);
    }

    function showAddCard(id) {
        document.getElementById('modalBox').innerHTML = `<h3>ğŸ’³ åŠ å…¥å¡ç‰‡</h3><input type="text" id="cN" class="input-box" placeholder="å¡ç‰‡åç¨±" oninput="autoFill(this.value)">
        <div id="tCon"></div><button onclick="addTierUI()" style="width:100%;padding:10px;margin-bottom:10px;border:1px dashed #e2e8f0;border-radius:12px;background:none;color:var(--primary);font-size:0.8em;">ï¼‹å¢åŠ å›é¥‹å±¤ç´š</button>
        <input type="text" id="cNo" class="input-box" placeholder="å‚™è¨»">
        <div class="modal-btns"><button class="btn-tool" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-record" style="flex:2" onclick="doAddCard(${id})">åŠ å…¥</button></div>`;
        addTierUI("5", "300"); document.getElementById('modalOverlay').style.display = 'flex';
    }

    function doAddCard(catId) {
        const n = document.getElementById('cN').value.trim(), nt = document.getElementById('cNo').value.trim();
        const rs = document.querySelectorAll('.t-r'), ls = document.querySelectorAll('.t-l');
        let ts = []; rs.forEach((r, i) => { if(r.value) ts.push({ rate: Number(r.value), limit: Number(ls[i].value) }); });
        if(n && ts.length) { data.find(c=>c.id===catId).cards.push({ id: Date.now(), name: n, tiers: ts, spent: 0, note: nt }); save(); closeModal(); }
    }

    function showRecord(catId, cardId) {
        const card = data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId);
        document.getElementById('modalBox').innerHTML = `<h3>ğŸ’° ç´€éŒ„æ¶ˆè²» (${card.name})</h3><input type="number" inputmode="decimal" id="sAmt" class="input-box" placeholder="0">
        <div class="modal-btns"><button class="btn-tool" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-record" style="flex:2" onclick="doRecord(${catId}, ${cardId})">ç´€éŒ„</button></div>`;
        document.getElementById('modalOverlay').style.display = 'flex'; setTimeout(() => document.getElementById('sAmt').focus(), 100);
    }
    function doRecord(catId, cardId) { const a = Number(document.getElementById('sAmt').value); if(a) { data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId).spent += a; save(); closeModal(); } }

    function showRewardDetail(name) {
        let ts = 0, tiers = [];
        data.forEach(cat => cat.cards.forEach(card => { if(card.name.trim()===name.trim()){ ts += (card.spent||0); tiers = card.tiers; } }));
        let minCap = 9999999; tiers.forEach(t => { if(t.limit<999999){ const c = Math.round(t.limit/(t.rate/100)); if(c<minCap) minCap = c; } });
        let html = `<h3>ğŸ“Š ${name} å›é¥‹è©¦ç®—</h3>`;
        tiers.forEach((t, i) => {
            const r = Math.floor(Math.min(ts * (t.rate/100), t.limit));
            html += `<div style="padding:10px;background:#f8fafc;border-radius:12px;margin-bottom:8px;font-size:0.9em;">å±¤ç´š ${i+1} (${t.rate}%)ï¼š<b>$${r.toLocaleString()}</b> / ${t.limit>=999999?'ç„¡ä¸Šé™':'$'+t.limit.toLocaleString()}</div>`;
        });
        html += `<div style="margin-top:15px;padding:12px;background:#fff5f5;border-radius:12px;color:var(--danger);font-weight:800;text-align:center">å‰©é¤˜å°é ‚ï¼š$${Math.max(0, minCap-ts).toLocaleString()}</div>
        <button class="btn-record" style="width:100%;margin-top:15px" onclick="closeModal()">é—œé–‰</button>`;
        document.getElementById('modalBox').innerHTML = html; document.getElementById('modalOverlay').style.display = 'flex';
    }

    function showEdit(catId, cardId, field) {
        const card = data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId);
        if (field === 'tiers') {
            document.getElementById('modalBox').innerHTML = `<h3>âš™ï¸ ä¿®æ”¹è¦å‰‡</h3><div id="tCon"></div><button onclick="addTierUI()" style="width:100%;padding:10px;margin-bottom:10px;border:2px dashed #ccc;border-radius:12px;background:none;">ï¼‹å¢åŠ åˆ†å±¤</button>
            <div class="modal-btns"><button class="btn-tool" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-record" style="flex:2" onclick="doSyncTiers(${catId}, ${cardId})">åŒæ­¥è¦å‰‡</button></div>`;
            card.tiers.forEach(t => addTierUI(t.rate, t.limit));
        } else {
            document.getElementById('modalBox').innerHTML = `<h3>âœï¸ ä¿®æ”¹è³‡è¨Š</h3><input type="${field==='spent'?'number':'text'}" id="editV" class="input-box" value="${card[field]||''}">
            <div class="modal-btns"><button class="btn-tool" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-record" style="flex:2" onclick="doEdit(${catId}, ${cardId}, '${field}')">å„²å­˜</button></div>`;
        }
        document.getElementById('modalOverlay').style.display = 'flex';
    }

    function doEdit(catId, cardId, field) {
        const v = document.getElementById('editV').value;
        const target = data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId), name = target.name;
        if (field === 'name') { data.forEach(c => c.cards.forEach(cd => { if(cd.name.trim()===name.trim()) cd.name = v.trim(); })); } 
        else { target[field] = (field==='spent' ? Number(v) : v.trim()); }
        save(); closeModal();
    }

    function doSyncTiers(catId, cardId) {
        const target = data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId);
        const rs = document.querySelectorAll('.t-r'), ls = document.querySelectorAll('.t-l');
        let ts = []; rs.forEach((r, i) => { if(r.value) ts.push({ rate: Number(r.value), limit: Number(ls[i].value) }); });
        data.forEach(c => c.cards.forEach(cd => { if(cd.name.trim()===target.name.trim()) cd.tiers = JSON.parse(JSON.stringify(ts)); }));
        save(); closeModal();
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `ä¿¡ç”¨å¡åŠ©æ‰‹å‚™ä»½_${new Date().toLocaleDateString()}.json`; a.click();
    }
    function importData(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) { try { let imp = JSON.parse(e.target.result); if(Array.isArray(imp)){ data = migrate(imp); save(); alert("åŒ¯å…¥æˆåŠŸï¼"); } } catch(err) { alert("è®€å–å¤±æ•—"); } };
        reader.readAsText(file);
    }
    function resetAll() { if(confirm("é‡ç½®æ‰€æœ‰æ¶ˆè²»é‡‘é¡ï¼Ÿ")) { data.forEach(c => c.cards.forEach(cd => cd.spent = 0)); save(); } }
    function autoFill(n) { for(let cat of data) for(let c of cat.cards) if(c.name.trim()===n.trim()){ const tCon=document.getElementById('tCon'); tCon.innerHTML=''; c.tiers.forEach(t=>addTierUI(t.rate,t.limit)); return; } }

    load();
</script>
</body>
</html>
