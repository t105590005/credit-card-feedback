<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿¡ç”¨å¡å›é¥‹åŠ©æ‰‹</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5f27cd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@500;700&family=M+PLUS+Rounded+1c:wght@500;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #f8f9ff; --card-bg: #ffffff;
            --primary: #5f27cd; --primary-light: #9980FA;
            --success: #1dd1a1; --warning: #ff9f43; --danger: #ee5253;
            --text-dark: #341f97; --text-card: #5f27cd;
            --note-bg: #f3f0ff; --note-text: #5f27cd;
            --limit-bg: #e6fffa; --limit-text: #00b894;
            /* é‡‘å¹£æŒ‰éˆ•è‰² */
            --coin-gold: #FFD166; --coin-border: #341f97;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Quicksand','Hiragino Maru Gothic ProN', 'M PLUS Rounded 1c',     'Microsoft JhengHei', sans-serif;
            background-color: var(--bg); color: var(--text-dark);
            margin: 0; padding: 12px;
            line-height: 1.5; letter-spacing: 0.02em;
            overflow-x: hidden;
        }

        .container { max-width: 480px; margin: 0 auto; padding-bottom: 120px; }

        /* SVG åœ–ç¤ºé€šç”¨è¨­å®š */
        .icon-svg {
            width: 1.1em; height: 1.1em;
            display: inline-block; vertical-align: middle;
            stroke-width: 2.5; stroke: currentColor; fill: none;
            stroke-linecap: round; stroke-linejoin: round;
            margin-right: 4px; position: relative; top: -1px;
        }

        /* å„€è¡¨æ¿ */
        .dashboard {
            background: linear-gradient(135deg, #5f27cd 0%, #341f97 100%);
            border-radius: 35px; padding: 25px; color: white;
            box-shadow: 0 15px 35px rgba(95, 39, 205, 0.25);
            margin-bottom: 25px; display: flex; justify-content: space-around;
        }
        .stat-value { font-size: 1.7em; font-weight: 800; }

        /* å¡ç‰‡èˆ‡åˆ†é¡ */
        .category-card {
            background: var(--card-bg); border-radius: 35px; margin-bottom: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.04); border: 1px solid rgba(95, 39, 205, 0.05);
            overflow: hidden;
        }
        .category-head { padding: 20px 25px; display: flex; justify-content: space-between; align-items: flex-start; cursor: pointer; }
        .category-info-wrap { display: flex; flex-direction: column; align-items: flex-start; gap: 6px; }
        .category-name { font-weight: 800; font-size: 1.25em; color: var(--text-dark); display: flex; align-items: center; }
        
        .subtotal-badge { 
            font-size: 0.75em; color: var(--primary); background: var(--note-bg); 
            padding: 5px 15px; border-radius: 50px; font-weight: 800; 
            border: 1px solid #e0d9ff; width: fit-content; white-space: nowrap;
        }

        .btn-small-add {
            background: none; border: 1.5px solid #e0e6ed; color: #94a3b8;
            padding: 5px 12px; border-radius: 15px; font-size: 0.75em; font-weight: 700;
            margin-top: 5px; display: flex; align-items: center;
        }

        .card-list { display: block; overflow: hidden; }
        .card-list.collapsed { display: none; }
        .card-item { padding: 25px; border-top: 1px solid #f8f9ff; }

        /* æ¨™ç±¤ä½ˆå±€ */
        .card-header-row { display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .card-info-area { flex: 1; min-width: 0; }
        .card-title { font-weight: 800; font-size: 1.25em; color: var(--text-card); margin-bottom: 8px; cursor: pointer; word-break: break-all; }
        
        .label-group { display: flex; flex-direction: row; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .pill {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 6px 14px; border-radius: 50px; font-size: 0.8em; font-weight: 800;
            width: fit-content; white-space: nowrap;
        }
        .pill-note { background: var(--note-bg); color: var(--note-text); border: 1.5px solid #e0d9ff; cursor: pointer; }
        .pill-limit { background: var(--limit-bg); color: var(--limit-text); border: 1.5px solid #c6f6d5; }

        /* ğŸª™ ç«‹é«”é‡‘å¹£æŒ‰éˆ• (å« SVG) */
        .btn-record { 
            background: var(--coin-gold); color: var(--coin-border); 
            border: 3px solid var(--coin-border);
            width: 48px; height: 48px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 4px 4px 0px var(--coin-border); 
            cursor: pointer; transition: 0.1s;
            flex-shrink: 0; user-select: none;
        }
        .btn-record svg { width: 1.6em; height: 1.6em; stroke-width: 3; margin: 0; top: 0; }
        .btn-record:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px var(--coin-border); }

        /* é€²åº¦æ¢ */
        .progress-box { background: #f1f5f9; height: 14px; border-radius: 50px; margin: 15px 0; cursor: pointer; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 50px; transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .bg-green { background: linear-gradient(90deg, #1dd1a1, #00d2d3); }
        .bg-orange { background: linear-gradient(90deg, #ff9f43, #ff6b6b); }
        .bg-red { background: linear-gradient(90deg, #ee5253, #ff4757); }

        .card-footer { display: flex; justify-content: space-between; font-size: 0.82em; color: #94a3b8; font-weight: 600; margin-top: 5px; flex-wrap: wrap; gap: 5px; }
        .clickable { color: var(--primary-light); text-decoration: underline; cursor: pointer; }

        /* åº•éƒ¨å·¥å…· */
        .admin-tools { display: flex; gap: 12px; margin-top: 30px; }
        .btn-tool { flex: 1; padding: 16px; border-radius: 20px; border: 1.5px solid #e2e8f0; background: white; font-weight: 800; color: #64748b; cursor: pointer; font-size: 0.85em; text-align: center; display: flex; justify-content: center; align-items: center; }

        /* å½ˆçª—ç³»çµ± (å›æ­¸ç½®ä¸­) */
        #modalOverlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(52, 31, 151, 0.5); backdrop-filter: blur(5px); 
            z-index: 999; 
            align-items: center; /* å‚ç›´ç½®ä¸­ */
            justify-content: center; /* æ°´å¹³ç½®ä¸­ */
        }
        .modal-body { 
            background: white; 
            width: 90%; max-width: 420px; 
            padding: 30px; 
            border-radius: 30px; /* å››è§’åœ“æ½¤ */
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); 
            animation: popIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            max-height: 90vh; overflow-y: auto;
        }
        @keyframes popIn { 
            from { opacity: 0; transform: scale(0.95); } 
            to { opacity: 1; transform: scale(1); } 
        }
        
        .input-box { width: 100%; padding: 16px; border: 2.5px solid #f1f5f9; border-radius: 20px; font-size: 16px; box-sizing: border-box; background: #f8fafc; outline: none; margin: 10px 0; font-family: inherit; }
        .input-box:focus { border-color: var(--primary-light); }
        .modal-btns { display: flex; gap: 15px; margin-top: 25px; }
        .btn-modal-confirm { flex: 2; padding: 18px; border-radius: 20px; border: none; background: var(--primary); color: white; font-weight: 800; cursor: pointer; font-family: inherit; }
        .btn-modal-cancel { flex: 1; padding: 18px; border-radius: 20px; border: none; background: #f1f5f9; color: #94a3b8; font-weight: 800; cursor: pointer; }
        
        .guide-text { font-size: 0.85em; color: #8395a7; margin-bottom: 10px; display: block; font-weight: 500; }
        .guide-accent { color: var(--primary); font-weight: 800; }
        h3 { display: flex; align-items: center; margin-top: 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="dashboard">
        <div style="text-align: center;">
            <span style="font-size: 0.8em; opacity: 0.8; display: block; margin-bottom: 5px; font-weight: 700;">æœ¬æœˆç¸½æ”¯å‡º</span>
            <div class="stat-value" id="globalTotalSpent">$0</div>
        </div>
        <div style="text-align: center;">
            <span style="font-size: 0.8em; opacity: 0.8; display: block; margin-bottom: 5px; font-weight: 700;">é è¨ˆå›é¥‹</span>
            <div class="stat-value" style="color: #ffd166" id="globalTotalReward">$0</div>
        </div>
    </div>

    <button onclick="showAddCat()" style="width: 100%; padding: 22px; border-radius: 25px; border: none; background: white; color: var(--primary); font-weight: 800; font-size: 1.05em; box-shadow: 0 12px 25px rgba(0,0,0,0.05); margin-bottom: 25px; cursor: pointer; font-family: inherit; display:flex; align-items:center; justify-content:center;">
        <svg class="icon-svg" viewBox="0 0 24 24" style="margin-right:8px"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
        æ–°å¢æ¶ˆè²»åˆ†é¡é »é“
    </button>

    <div id="mainDisplay"></div>

    <div class="admin-tools">
        <button class="btn-tool" onclick="exportData()"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> å‚™ä»½</button>
        <button class="btn-tool" onclick="document.getElementById('fileInput').click()"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> åŒ¯å…¥</button>
        <button class="btn-tool" style="color: var(--danger); border-color: #ffccd5;" onclick="resetAll()"><svg class="icon-svg" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> æ­¸é›¶</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(event)" accept=".json">
    </div>
</div>

<div id="modalOverlay" onclick="if(event.target==this)closeModal()"><div class="modal-body" id="modalBox"></div></div>

<script>
    const STORAGE_KEY = 'cardTracker_Centered_v1';
    let data = [];

    // --- SVG åœ–ç¤ºå®šç¾© ---
    const ICONS = {
        edit: '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',
        money: '<svg class="icon-svg" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>',
        card: '<svg class="icon-svg" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>',
        settings: '<svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>',
        plus: '<svg class="icon-svg" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
        chart: '<svg class="icon-svg" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>'
    };

    function load() {
        try {
            let saved = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            data = migrate(saved);
            render();
        } catch(e) { data = []; render(); }
    }

    function migrate(list) {
        return list.map(cat => ({
            ...cat,
            cards: cat.cards.map(card => {
                if (!card.tiers) return { ...card, tiers: [{ rate: card.rate || 0, limit: card.limit || 0 }] };
                return card;
            })
        }));
    }

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); render(); }
    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

    function toggleCategory(id) {
        const cat = data.find(c => c.id === id);
        if (cat) { cat.isCollapsed = !cat.isCollapsed; save(); }
    }

    function render() {
        const container = document.getElementById('mainDisplay');
        container.innerHTML = '';
        let gSpent = {};
        
        data.forEach(cat => cat.cards.forEach(card => {
            const n = card.name.trim();
            gSpent[n] = (gSpent[n] || 0) + (card.spent || 0);
        }));

        data.forEach(cat => {
            let catHtml = "", catTotal = 0;
            cat.cards.forEach(card => {
                const totalS = gSpent[card.name.trim()];
                catTotal += (card.spent || 0);
                
                let minCap = 9999999;
                card.tiers.forEach(t => { 
                    if (t.limit < 999999) { 
                        const cap = Math.round(t.limit / (t.rate / 100)); 
                        if (cap < minCap) minCap = cap; 
                    } 
                });
                
                const pct = Math.min((totalS / minCap) * 100, 100);
                const rem = Math.max(0, minCap - totalS);
                let col = "bg-green"; if(pct>=100) col="bg-red"; else if(pct>=80) col="bg-orange";

                catHtml += `
                <div class="card-item">
                    <div class="card-header-row">
                        <div class="card-info-area" onclick="showEdit(${cat.id}, ${card.id}, 'name')">
                            <div class="card-title">${card.name}</div>
                            <div class="label-group">
                                <div class="pill pill-note" onclick="event.stopPropagation(); showEdit(${cat.id}, ${card.id}, 'note')">
                                    ${ICONS.edit} ${card.note || 'å‚™è¨»'}
                                </div>
                                <div class="pill pill-limit">
                                    ${ICONS.money} å‰© $${rem.toLocaleString()}
                                </div>
                            </div>
                        </div>
                        <button class="btn-record" onclick="showRecord(${cat.id}, ${card.id})">${ICONS.money}</button>
                    </div>
                    <div class="progress-box" onclick="showRewardDetail('${card.name}')">
                        <div class="progress-fill ${col}" style="width: ${pct}%"></div>
                    </div>
                    <div class="card-footer">
                        <span>ç¸½åˆ·: <b>$${totalS.toLocaleString()}</b> (æ­¤åœ°: <span class="clickable" onclick="showEdit(${cat.id}, ${card.id}, 'spent')">$${(card.spent||0).toLocaleString()}</span>)</span>
                        <span class="clickable" onclick="showEdit(${cat.id}, ${card.id}, 'tiers')">${card.tiers.length}å±¤è¦å‰‡ ${ICONS.settings}</span>
                    </div>
                    <div style="text-align:right; margin-top:10px;"><button style="background:none;border:none;color:#cbd5e1;font-size:0.75em;cursor:pointer;" onclick="if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){data.find(c=>c.id===${cat.id}).cards=data.find(c=>c.id===${cat.id}).cards.filter(cd=>cd.id!==${card.id});save();}">âœ• åˆªé™¤é …ç›®</button></div>
                </div>`;
            });

            container.innerHTML += `
            <div class="category-card">
                <div class="category-head" onclick="toggleCategory(${cat.id})">
                    <div class="category-info-wrap">
                        <div class="category-name"><span>${cat.isCollapsed ? 'â–¶' : 'â–¼'}</span> ${cat.name}</div>
                        <div class="subtotal-badge">å°è¨ˆï¼š$${catTotal.toLocaleString()}</div>
                    </div>
                    <button class="btn-small-add" onclick="event.stopPropagation(); showAddCard(${cat.id})">${ICONS.plus} å¡ç‰‡</button>
                </div>
                <div class="card-list ${cat.isCollapsed ? 'collapsed' : ''}">${catHtml || '<div style="padding:30px;text-align:center;color:#cbd5e1;font-size:0.9em;">é»æ“Šã€Œï¼‹å¡ç‰‡ã€é–‹å§‹ç´€éŒ„</div>'}</div>
            </div>`;
        });

        let totalS = 0, totalR = 0, done = {};
        data.forEach(cat => cat.cards.forEach(card => {
            totalS += (card.spent || 0);
            const n = card.name.trim();
            if (!done[n]) { 
                card.tiers.forEach(t => { 
                    totalR += Math.floor(Math.min(gSpent[n] * (t.rate / 100), t.limit)); 
                }); 
                done[n] = true; 
            }
        }));
        document.getElementById('globalTotalSpent').innerText = '$' + totalS.toLocaleString();
        document.getElementById('globalTotalReward').innerText = '$' + Math.floor(totalR).toLocaleString();
    }

    // --- æ™ºæ…§å‚™ä»½ (æ™‚é–“æˆ³è¨˜) ---
    async function exportData() {
        const now = new Date();
        const timestamp = now.getFullYear() +
            String(now.getMonth() + 1).padStart(2, '0') +
            String(now.getDate()).padStart(2, '0') + '_' +
            String(now.getHours()).padStart(2, '0') +
            String(now.getMinutes()).padStart(2, '0');
        const fileName = `ä¿¡ç”¨å¡åŠ©æ‰‹å‚™ä»½_${timestamp}.json`;
        const jsonString = JSON.stringify(data, null, 2);

        try {
            if (window.showSaveFilePicker) {
                const handle = await window.showSaveFilePicker({ suggestedName: fileName, types: [{ description: 'JSON Backup', accept: { 'application/json': ['.json'] } }] });
                const writable = await handle.createWritable(); await writable.write(jsonString); await writable.close();
                alert("å‚™ä»½æˆåŠŸï¼");
            } else { throw new Error("Fallback"); }
        } catch (err) {
            const blob = new Blob([jsonString], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fileName;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
    }

    function showRecord(catId, cardId) {
        const card = data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId);
        document.getElementById('modalBox').innerHTML = `<h3>${ICONS.money} ç´€éŒ„æ¶ˆè²» (${card.name})</h3><span class="guide-text">ğŸ’¡ æ­£åœ¨ç´€éŒ„åˆ° <span class="guide-accent">${card.name}</span></span><input type="number" inputmode="decimal" id="sAmt" class="input-box" placeholder="è«‹è¼¸å…¥é‡‘é¡"><div class="modal-btns"><button class="btn-modal-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-modal-confirm" onclick="const a=Number(document.getElementById('sAmt').value); if(a){data.find(c=>c.id===${catId}).cards.find(cd=>cd.id===${cardId}).spent+=a; save(); closeModal();}">ç¢ºèªç´€éŒ„</button></div>`;
        document.getElementById('modalOverlay').style.display='flex';
        setTimeout(()=>document.getElementById('sAmt').focus(),100);
    }

    function showEdit(catId, cardId, field) {
        const card = data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId);
        const labels = {'name': `${ICONS.edit} ä¿®æ”¹åç¨±`, 'spent': `${ICONS.money} ä¿®æ”¹é‡‘é¡`, 'note': `${ICONS.edit} ä¿®æ”¹å‚™è¨»`, 'tiers': `${ICONS.settings} ä¿®æ”¹è¦å‰‡`};
        let scopeHint = (field === 'name' || field === 'tiers') ? 'ğŸ’¡ æ³¨æ„ï¼šä¿®æ”¹æ­¤é …å°‡<span class="guide-accent">åŒæ­¥è‡³æ‰€æœ‰é€šè·¯</span>çš„åŒåå¡ç‰‡ã€‚' : 'ğŸ’¡ æç¤ºï¼šæ­¤é …ä¿®æ”¹<span class="guide-accent">åƒ…å½±éŸ¿ç›®å‰çš„é€šè·¯</span>ã€‚';

        if (field === 'tiers') {
            document.getElementById('modalBox').innerHTML = `<h3>${labels[field]}</h3><span class="guide-text">${scopeHint}</span><div id="tCon"></div><button onclick="addTierUI()" style="width:100%;padding:10px;margin-bottom:10px;border:2px dashed #ccc;border-radius:18px;background:none;font-weight:800;font-family:inherit;">ï¼‹å¢åŠ åˆ†å±¤</button><div class="modal-btns"><button class="btn-modal-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-modal-confirm" onclick="doSyncTiers(${catId}, ${cardId})">åŒæ­¥ä¿®æ”¹</button></div>`;
            card.tiers.forEach(t => addTierUI(t.rate, t.limit));
        } else {
            const isNum = (field === 'spent');
            document.getElementById('modalBox').innerHTML = `<h3>${labels[field]}</h3><span class="guide-text">${scopeHint}</span><input type="${isNum?'number':'text'}" id="editV" class="input-box" value="${card[field]||''}"> <div class="modal-btns"><button class="btn-modal-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-modal-confirm" onclick="doEdit(${catId}, ${cardId}, '${field}')">ç¢ºå®šå„²å­˜</button></div>`;
        }
        document.getElementById('modalOverlay').style.display='flex';
    }

    function showAddCat() { document.getElementById('modalBox').innerHTML = `<h3>${ICONS.plus} æ–°å¢åˆ†é¡é »é“</h3><span class="guide-text">ğŸ’¡ å»ºç«‹æ‚¨çš„æ¶ˆè²»å ´æ™¯ï¼ˆå¦‚ï¼šå¤–é€ã€äº¤é€šï¼‰</span><input type="text" id="catN" class="input-box" placeholder="åç¨±"><div class="modal-btns"><button class="btn-modal-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-modal-confirm" onclick="const n=document.getElementById('catN').value; if(n){data.push({id:Date.now(),name:n,cards:[],isCollapsed:false});save();closeModal();}">å»ºç«‹</button></div>`; document.getElementById('modalOverlay').style.display='flex'; }
    function addTierUI(r="", l="") { const div = document.createElement('div'); div.style.display="flex"; div.style.gap="10px"; div.style.marginBottom="10px"; div.innerHTML = `<input type="number" class="input-box t-r" placeholder="%" style="flex:1" value="${r}"><input type="number" class="input-box t-l" placeholder="ä¸Šé™" style="flex:2" value="${l}"><button onclick="this.parentElement.remove()" style="border:none;background:none;color:var(--danger);font-size:1.5em;">âœ•</button>`; document.getElementById('tCon').appendChild(div); }
    function showAddCard(id) { document.getElementById('modalBox').innerHTML = `<h3>${ICONS.card} åŠ å…¥æ–°å¡ç‰‡</h3><span class="guide-text">ğŸ’¡ è‹¥åç¨±é‡è¤‡ï¼Œå°‡è‡ªå‹•å¥—ç”¨ç¾æœ‰è¦å‰‡ã€‚</span><input type="text" id="cN" class="input-box" placeholder="åç¨±" oninput="autoFill(this.value)"><div id="tCon"></div><button onclick="addTierUI()" style="width:100%;padding:14px;margin-bottom:15px;border:2px dashed #e2e8f0;border-radius:20px;background:none;color:var(--primary);font-weight:800;font-size:0.85em;font-family:inherit;">ï¼‹å¢åŠ å›é¥‹åˆ†å±¤</button><input type="text" id="cNo" class="input-box" placeholder="å‚™è¨»"><div class="modal-btns"><button class="btn-modal-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-modal-confirm" onclick="doAddCard(${id})">ç¢ºèªåŠ å…¥</button></div>`; addTierUI("5", "300"); document.getElementById('modalOverlay').style.display='flex'; }
    function doAddCard(catId) { const n = document.getElementById('cN').value.trim(), nt = document.getElementById('cNo').value.trim(), rs = document.querySelectorAll('.t-r'), ls = document.querySelectorAll('.t-l'); let ts = []; rs.forEach((r, i) => { if(r.value) ts.push({ rate: Number(r.value), limit: Number(ls[i].value) }); }); if(n && ts.length) { data.find(c=>c.id===catId).cards.push({ id: Date.now(), name: n, tiers: ts, spent: 0, note: nt }); save(); closeModal(); } }
    function showRewardDetail(name) { let ts = 0, tiers = []; data.forEach(cat => cat.cards.forEach(card => { if(card.name.trim()===name.trim()){ ts += (card.spent||0); tiers = card.tiers; } })); let minCap = 9999999; tiers.forEach(t => { if(t.limit<999999){ const c = Math.round(t.limit/(t.rate/100)); if(c<minCap) minCap = c; } }); let html = `<h3>${ICONS.chart} å›é¥‹è©¦ç®—</h3>`; tiers.forEach((t, i) => { const r = Math.floor(Math.min(ts * (t.rate/100), t.limit)); html += `<div style="padding:12px;background:#f8fafc;border-radius:18px;margin-bottom:10px;font-size:0.9em;font-weight:700;">åˆ†å±¤ ${i+1} (${t.rate}%)ï¼š<b>$${r.toLocaleString()}</b> / ${t.limit>=999999?'ç„¡ä¸Šé™':'$'+t.limit.toLocaleString()}</div>`; }); html += `<div style="margin-top:20px;padding:18px;background:#fff5f5;border-radius:20px;color:var(--danger);font-weight:800;text-align:center">å‰©é¤˜å°é ‚ï¼š$${Math.max(0, minCap-ts).toLocaleString()}</div><button class="btn-modal-confirm" style="width:100%;margin-top:20px" onclick="closeModal()">äº†è§£</button>`; document.getElementById('modalBox').innerHTML = html; document.getElementById('modalOverlay').style.display='flex'; }
    function doEdit(catId, cardId, field) { const v = document.getElementById('editV').value; const target = data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId), name = target.name; if (field === 'name') { data.forEach(c => c.cards.forEach(cd => { if(cd.name.trim()===name.trim()) cd.name = v.trim(); })); } else { target[field] = (field==='spent' ? Number(v) : v.trim()); } save(); closeModal(); }
    function doSyncTiers(catId, cardId) { const target = data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId); const rs = document.querySelectorAll('.t-r'), ls = document.querySelectorAll('.t-l'); let ts = []; rs.forEach((r, i) => { if(r.value) ts.push({ rate: Number(r.value), limit: Number(ls[i].value) }); }); data.forEach(c => c.cards.forEach(cd => { if(cd.name.trim()===target.name.trim()) cd.tiers = JSON.parse(JSON.stringify(ts)); })); save(); closeModal(); }
    function importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { let imp = JSON.parse(e.target.result); if(Array.isArray(imp)){ data = migrate(imp); save(); alert("åŒ¯å…¥æˆåŠŸï¼"); } } catch(err) { alert("æ ¼å¼éŒ¯èª¤"); } }; reader.readAsText(file); }
    function resetAll() { if(confirm("ç¢ºå®šé‡ç½®æœ¬æœˆé‡‘é¡ï¼Ÿ")) { data.forEach(c => c.cards.forEach(cd => cd.spent = 0)); save(); } }
    function autoFill(n) { for(let cat of data) for(let c of cat.cards) if(c.name.trim()===n.trim()){ const tCon=document.getElementById('tCon'); tCon.innerHTML=''; c.tiers.forEach(t=>addTierUI(t.rate,t.limit)); return; } }

    load();
</script>
</body>
</html>
