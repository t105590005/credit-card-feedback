<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿¡ç”¨å¡å›é¥‹åŠ©æ‰‹</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8f9ff; --card-bg: #ffffff;
            --primary: #5f27cd; --primary-light: #9980FA;
            --success: #00d2d3; --warning: #ff9f43; --danger: #ee5253;
            /* ç´«è‰²æ–‡å­—è‰²ç³» */
            --text-dark: #341f97; /* æ·±ç´«å¤§æ¨™ */
            --text-card: #5f27cd; /* å¡ç‰‡æ¨™é¡Œç´« */
            --text-light: #8395a7; --sub-bg: #f3f0ff; --sub-text: #5f27cd;
        }

        body { 
            font-family: 'Quicksand', 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background-color: var(--bg); color: var(--text-dark);
            margin: 0; padding: 16px; -webkit-tap-highlight-color: transparent;
        }

        .container { max-width: 480px; margin: 0 auto; padding-bottom: 120px; }

        /* é ‚éƒ¨ç´«è‰²å„€è¡¨æ¿ */
        .header-stats {
            background: linear-gradient(135deg, #5f27cd 0%, #341f97 100%);
            border-radius: 28px; padding: 25px; color: white;
            box-shadow: 0 12px 30px rgba(95, 39, 205, 0.3);
            margin-bottom: 25px; display: flex; justify-content: space-between;
        }
        .stat-item span { font-size: 0.85em; opacity: 0.85; display: block; margin-bottom: 5px; font-weight: 500; }
        .stat-value { font-size: 1.8em; font-weight: 700; letter-spacing: -0.5px; }

        /* åˆ†é¡å¡ç‰‡ */
        .category-card {
            background: var(--card-bg); border-radius: 24px; margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.04); border: 1px solid rgba(95, 39, 205, 0.08);
            overflow: hidden;
        }
        .category-head {
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            background: #ffffff; cursor: pointer;
        }
        .category-info { display: flex; flex-direction: column; gap: 6px; }
        .category-name { font-weight: 700; font-size: 1.2em; color: var(--text-dark); display: flex; align-items: center; gap: 8px; }
        .category-badge { 
            font-size: 0.75em; color: var(--sub-text); background: var(--sub-bg);
            padding: 5px 12px; border-radius: 14px; font-weight: 700; width: fit-content;
        }
        .btn-add-item {
            background: none; border: 2px solid var(--primary-light); color: var(--primary-light);
            padding: 6px 14px; border-radius: 12px; font-size: 0.75em; font-weight: 700; transition: 0.2s;
        }

        /* å¡ç‰‡å…§å®¹å€ */
        .card-list { display: block; overflow: hidden; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-list.collapsed { display: none; }
        .card-item { padding: 22px 20px; border-top: 1px solid #f8f9ff; position: relative; }

        /* é€²åº¦æ¢ */
        .progress-box { background: #f0f1f7; height: 14px; border-radius: 10px; margin: 14px 0; cursor: pointer; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 0.8s ease; }
        .bg-green { background: linear-gradient(90deg, #00d2d3, #1dd1a1); }
        .bg-orange { background: linear-gradient(90deg, #ff9f43, #ff6b6b); }
        .bg-red { background: linear-gradient(90deg, #ee5253, #ff4757); }

        /* å·¦å´æ–‡å­—å…¨é¢ç´«è‰²åŒ– */
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
        .card-title { font-weight: 700; font-size: 1.15em; color: var(--text-card); cursor: pointer; }
        .note-tag { font-size: 0.8em; color: var(--primary-light); margin-top: 6px; display: block; font-weight: 500; }
        .limit-hint { font-size: 0.8em; color: var(--primary-light); font-weight: 700; margin-top: 4px; }
        
        .btn-record { 
            background: var(--primary); color: white; border: none; padding: 10px 18px; 
            border-radius: 14px; font-weight: 700; font-size: 0.9em; 
            box-shadow: 0 6px 15px rgba(95, 39, 205, 0.25); cursor: pointer;
        }

        .card-footer { display: flex; justify-content: space-between; font-size: 0.85em; color: #8395a7; margin-top: 10px; font-weight: 500; }
        .clickable { color: var(--primary-light); font-weight: 700; text-decoration: underline; cursor: pointer; }

        /* å·¥å…·æ¬„ */
        .bottom-tools { display: flex; gap: 12px; margin-top: 25px; }
        .btn-tool {
            flex: 1; padding: 15px; border-radius: 18px; border: 1.5px solid #e0e6ed;
            background: white; color: var(--text-light); font-weight: 700; font-size: 0.85em;
            display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;
        }

        /* å½ˆçª—æ¨£å¼ */
        #modalOverlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(52, 31, 151, 0.5); backdrop-filter: blur(8px); 
            z-index: 999; align-items: flex-end; justify-content: center;
        }
        .modal-body { 
            background: white; width: 100%; max-width: 500px; padding: 35px; 
            border-radius: 35px 35px 0 0; box-shadow: 0 -15px 40px rgba(0,0,0,0.15);
            animation: slideUp 0.35s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .input-box { width: 100%; padding: 15px; border: 2px solid #f1f5f9; border-radius: 16px; font-size: 16px; box-sizing: border-box; background: #f8fafc; outline: none; margin: 10px 0; }
        .modal-btns { display: flex; gap: 15px; margin-top: 25px; }
        .btn-cancel { flex: 1; padding: 16px; border-radius: 16px; border: none; background: #f1f5f9; color: var(--text-light); font-weight: 700; cursor: pointer; }
        .btn-confirm { flex: 2; padding: 16px; border-radius: 16px; border: none; background: var(--primary); color: white; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-stats">
        <div class="stat-item">
            <span>ç´¯ç©åŠ ç¸½æ¶ˆè²»é¡</span>
            <div class="stat-value" id="globalTotalSpent">$0</div>
        </div>
        <div class="stat-item" style="text-align: right;">
            <span>é è¨ˆç´¯ç©å›é¥‹</span>
            <div class="stat-value" style="color: #ffd166" id="globalTotalReward">$0</div>
        </div>
    </div>

    <button onclick="showAddCat()" style="width: 100%; padding: 20px; border-radius: 22px; border: none; background: white; color: var(--primary); font-weight: 800; font-size: 1.05em; box-shadow: 0 10px 25px rgba(0,0,0,0.06); margin-bottom: 25px; cursor: pointer;">
        âœ¨ æ–°å¢æ¶ˆè²»åˆ†é¡é »é“
    </button>

    <div id="mainDisplay"></div>

    <div class="bottom-tools">
        <button class="btn-tool" onclick="exportData()">ğŸ“¤ åŒ¯å‡ºå‚™ä»½</button>
        <button class="btn-tool" onclick="document.getElementById('fileInput').click()">ğŸ“¥ åŒ¯å…¥ç´€éŒ„</button>
        <button class="btn-tool" style="color: var(--danger); border-color: #ffccd5;" onclick="resetAll()">ğŸ§¹ æ¸…ç©ºæ­¸é›¶</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(event)" accept=".json">
    </div>
</div>

<div id="modalOverlay"><div class="modal-body" id="modalBox"></div></div>

<script>
    // é‚è¼¯æ ¸å¿ƒç¶­æŒ 2026 PRO ç‰ˆæœ¬çµæ§‹
    const STORAGE_KEY = 'cardTracker_2026_pro_purple';
    let data = [];

    function load() {
        try {
            let saved = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            data = migrate(saved);
            render();
        } catch(e) { data = []; render(); }
    }

    function migrate(list) {
        return list.map(cat => ({
            ...cat,
            cards: cat.cards.map(card => {
                if (!card.tiers) {
                    return { ...card, tiers: [{ rate: card.rate || 0, limit: card.limit || 0 }] };
                }
                return card;
            })
        }));
    }

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); render(); }

    const modal = document.getElementById('modalOverlay');
    const modalBox = document.getElementById('modalBox');
    function closeModal() { modal.style.display = 'none'; }

    function toggleCategory(id) {
        const cat = data.find(c => c.id === id);
        if (cat) { cat.isCollapsed = !cat.isCollapsed; save(); }
    }

    function render() {
        const container = document.getElementById('mainDisplay');
        container.innerHTML = '';
        let gSpent = {};
        data.forEach(cat => cat.cards.forEach(card => {
            const n = card.name.trim();
            gSpent[n] = (gSpent[n] || 0) + (card.spent || 0);
        }));

        data.forEach(cat => {
            let catHtml = "", catTotal = 0;
            cat.cards.forEach(card => {
                const totalS = gSpent[card.name.trim()];
                catTotal += (card.spent || 0);
                
                let minCap = 9999999;
                card.tiers.forEach(t => {
                    if (t.limit < 999999) {
                        const cap = Math.round(t.limit / (t.rate / 100));
                        if (cap < minCap) minCap = cap;
                    }
                });
                
                const pct = Math.min((totalS / minCap) * 100, 100);
                const rem = Math.max(0, minCap - totalS);
                let col = "bg-green"; if(pct>=100) col="bg-red"; else if(pct>=80) col="bg-orange";

                catHtml += `
                <div class="card-item">
                    <div class="card-top">
                        <div onclick="showEdit(${cat.id}, ${card.id}, 'name')">
                            <div class="card-title">${card.name}</div>
                            <span class="note-tag" onclick="event.stopPropagation(); showEdit(${cat.id}, ${card.id}, 'note')">${card.note || '+ é»æ“Šæ–°å¢å‚™è¨»'}</span>
                            <div class="limit-hint">è·é›¢å°é ‚é‚„èƒ½åˆ·ï¼š$${rem.toLocaleString()}</div>
                        </div>
                        <button class="btn-record" onclick="showRecord(${cat.id}, ${card.id})">ï¼‹ç´€éŒ„</button>
                    </div>
                    <div class="progress-box" onclick="showRewardDetail('${card.name}')">
                        <div class="progress-fill ${col}" style="width: ${pct}%"></div>
                    </div>
                    <div class="card-footer">
                        <span>ç¸½æ”¯å‡º: <b>$${totalS.toLocaleString()}</b> (æ­¤é€šè·¯: <span class="clickable" onclick="showEdit(${cat.id}, ${card.id}, 'spent')">$${(card.spent||0).toLocaleString()}</span>)</span>
                        <span class="clickable" onclick="showEdit(${cat.id}, ${card.id}, 'tiers')">${card.tiers.length} å±¤å›é¥‹è¦å‰‡ âš™ï¸</span>
                    </div>
                </div>`;
            });

            container.innerHTML += `
            <div class="category-card">
                <div class="category-head" onclick="toggleCategory(${cat.id})">
                    <div class="category-info">
                        <div class="category-name"><span>${cat.isCollapsed ? 'â–¶' : 'â–¼'}</span> ${cat.name}</div>
                        <div class="category-badge">æœ¬é€šè·¯ç´¯ç©ï¼š$${catTotal.toLocaleString()}</div>
                    </div>
                    <button class="btn-add-item" onclick="event.stopPropagation(); showAddCard(${cat.id})">ï¼‹åŠ å…¥æ–°å¡</button>
                </div>
                <div class="card-list ${cat.isCollapsed ? 'collapsed' : ''}">${catHtml || '<div style="padding:40px;text-align:center;color:#b2bec3;font-size:0.95em;">é€™è£¡ç©ºç©ºçš„ï¼Œå¿«é»æ“Šä¸Šæ–¹ã€ŒåŠ å…¥æ–°å¡ã€</div>'}</div>
            </div>`;
        });

        let totalS = 0, totalR = 0, done = {};
        data.forEach(cat => cat.cards.forEach(card => {
            totalS += (card.spent || 0);
            const n = card.name.trim();
            if (!done[n]) {
                card.tiers.forEach(t => {
                    totalR += Math.floor(Math.min(gSpent[n] * (t.rate / 100), t.limit));
                });
                done[n] = true;
            }
        }));
        document.getElementById('globalTotalSpent').innerText = '$' + totalS.toLocaleString();
        document.getElementById('globalTotalReward').innerText = '$' + totalR.toLocaleString();
    }

    // --- äº’å‹•åŠŸèƒ½ (ç•¥ï¼Œç¶­æŒèˆ‡ 2026 PRO åŒæ­¥) ---
    function showAddCat() {
        modalBox.innerHTML = `<h3 style="color:var(--text-dark)">ğŸ’œ æ–°å¢æ¶ˆè²»åˆ†é¡</h3>
        <input type="text" id="catN" class="input-box" placeholder="è¼¸å…¥é€šè·¯åç¨±ï¼ˆå¦‚ï¼šUberã€äº¤é€šï¼‰">
        <div class="modal-btns"><button class="btn-cancel" onclick="closeModal()">æˆ‘å†æƒ³æƒ³</button><button class="btn-confirm" onclick="doAddCat()">ç¢ºå®šå»ºç«‹</button></div>`;
        modal.style.display = 'flex';
    }
    function doAddCat() { const n = document.getElementById('catN').value.trim(); if(n) { data.push({id: Date.now(), name: n, cards: [], isCollapsed: false}); save(); closeModal(); } }

    function addTierUI(r="", l="") {
        const div = document.createElement('div'); div.style.marginBottom = "10px";
        div.innerHTML = `<div style="display:flex;gap:12px;"><input type="number" class="input-box t-r" placeholder="%" style="flex:1" value="${r}"><input type="number" class="input-box t-l" placeholder="ä¸Šé™$" style="flex:2" value="${l}"><button onclick="this.parentElement.parentElement.remove()" style="border:none;background:none;color:var(--danger);font-size:1.4em;">âœ•</button></div>`;
        document.getElementById('tCon').appendChild(div);
    }

    function showAddCard(id) {
        modalBox.innerHTML = `<h3 style="color:var(--text-dark)">ğŸ’³ åŠ å…¥ä¿¡ç”¨å¡</h3>
        <input type="text" id="cN" class="input-box" placeholder="å¡ç‰‡åç¨±" oninput="autoFill(this.value)">
        <div id="tCon"></div><button onclick="addTierUI()" style="width:100%;padding:12px;margin:10px 0;border:2px dashed var(--primary-light);border-radius:16px;background:none;color:var(--primary);font-weight:700;">ï¼‹å¢åŠ å›é¥‹å±¤ç´š</button>
        <input type="text" id="cNo" class="input-box" placeholder="å‚™è¨»ï¼ˆå¦‚ï¼šéœ€ç™»éŒ„ã€Apple Payï¼‰">
        <div class="modal-btns"><button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-confirm" onclick="doAddCard(${id})">ç¢ºèªåŠ å…¥</button></div>`;
        addTierUI("5", "300"); modal.style.display = 'flex';
    }

    function doAddCard(catId) {
        const n = document.getElementById('cN').value.trim();
        const nt = document.getElementById('cNo').value.trim();
        const rs = document.querySelectorAll('.t-r'), ls = document.querySelectorAll('.t-l');
        let ts = []; rs.forEach((r, i) => { if(r.value) ts.push({ rate: Number(r.value), limit: Number(ls[i].value) }); });
        if(n && ts.length) { data.find(c=>c.id===catId).cards.push({ id: Date.now(), name: n, tiers: ts, spent: 0, note: nt }); save(); closeModal(); }
    }

    function showRecord(catId, cardId) {
        const card = data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId);
        modalBox.innerHTML = `<h3 style="color:var(--text-dark)">ğŸ’° ç´€éŒ„é‡‘é¡ (${card.name})</h3>
        <input type="number" inputmode="decimal" id="sAmt" class="input-box" placeholder="è¼¸å…¥æœ¬æ¬¡åˆ·å¡é‡‘é¡">
        <div class="modal-btns"><button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-confirm" onclick="doRecord(${catId}, ${cardId})">ç¢ºå®šç´€éŒ„</button></div>`;
        modal.style.display = 'flex'; setTimeout(() => document.getElementById('sAmt').focus(), 100);
    }
    function doRecord(catId, cardId) { const a = Number(document.getElementById('sAmt').value); if(a) { data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId).spent += a; save(); closeModal(); } }

    function showRewardDetail(name) {
        let ts = 0, tiers = [];
        data.forEach(cat => cat.cards.forEach(card => { if(card.name.trim()===name.trim()){ ts += (card.spent||0); tiers = card.tiers; } }));
        let minCap = 9999999; tiers.forEach(t => { if(t.limit<999999){ const c = Math.round(t.limit/(t.rate/100)); if(c<minCap) minCap = c; } });
        let html = `<h3 style="color:var(--text-dark)">ğŸ“Š ${name} è©¦ç®—è©³æƒ…</h3><div style="margin-bottom:15px;color:var(--primary);font-weight:700;">åŠ ç¸½ç´¯ç©æ¶ˆè²»ï¼š$${ts.toLocaleString()}</div>`;
        tiers.forEach((t, i) => {
            const r = Math.floor(Math.min(ts * (t.rate/100), t.limit));
            html += `<div style="padding:15px;background:var(--sub-bg);border-radius:16px;margin-bottom:12px;font-size:0.95em;color:var(--text-dark);">å±¤ç´š ${i+1} (${t.rate}%)ï¼š<b>$${r.toLocaleString()}</b> / ${t.limit>=999999?'ç„¡ä¸Šé™':'$'+t.limit.toLocaleString()}</div>`;
        });
        html += `<div style="margin-top:15px;padding:15px;background:#fff5f5;border-radius:16px;color:var(--danger);font-weight:800;">è·é›¢å°é ‚å‰©ï¼š$${Math.max(0, minCap-ts).toLocaleString()}</div>`;
        html += `<button class="btn-confirm" style="width:100%;margin-top:20px;" onclick="closeModal()">äº†è§£</button>`;
        modalBox.innerHTML = html; modal.style.display = 'flex';
    }

    function showEdit(catId, cardId, field) {
        const card = data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId);
        if (field === 'tiers') {
            modalBox.innerHTML = `<h3 style="color:var(--text-dark)">âš™ï¸ ä¿®æ”¹å›é¥‹è¦å‰‡</h3><div id="tCon"></div><button onclick="addTierUI()" style="width:100%;padding:12px;border:2px dashed #ccc;border-radius:16px;background:none;font-weight:700;">ï¼‹å¢åŠ åˆ†å±¤</button>
            <div class="modal-btns"><button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-confirm" onclick="doSyncTiers(${catId}, ${cardId})">åŒæ­¥ä¿®æ”¹</button></div>`;
            card.tiers.forEach(t => addTierUI(t.rate, t.limit));
        } else {
            modalBox.innerHTML = `<h3 style="color:var(--text-dark)">âœï¸ ä¿®æ”¹è³‡è¨Š</h3><input type="${field==='spent'?'number':'text'}" id="editV" class="input-box" value="${card[field]||''}">
            <div class="modal-btns"><button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-confirm" onclick="doEdit(${catId}, ${cardId}, '${field}')">ç¢ºå®š</button></div>`;
        }
        modal.style.display = 'flex';
    }

    function doEdit(catId, cardId, field) {
        const v = document.getElementById('editV').value;
        const target = data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId);
        const name = target.name;
        if (field === 'name') {
            data.forEach(c => c.cards.forEach(cd => { if(cd.name.trim()===name.trim()) cd.name = v.trim(); }));
        } else { target[field] = (field==='spent' ? Number(v) : v.trim()); }
        save(); closeModal();
    }

    function doSyncTiers(catId, cardId) {
        const target = data.find(c=>c.id===catId).cards.find(cd=>cd.id===cardId);
        const rs = document.querySelectorAll('.t-r'), ls = document.querySelectorAll('.t-l');
        let ts = []; rs.forEach((r, i) => { if(r.value) ts.push({ rate: Number(r.value), limit: Number(ls[i].value) }); });
        data.forEach(c => c.cards.forEach(cd => { if(cd.name.trim()===target.name.trim()) cd.tiers = JSON.parse(JSON.stringify(ts)); }));
        save(); closeModal();
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `ä¿¡ç”¨å¡åŠ©æ‰‹å‚™ä»½_${new Date().toLocaleDateString()}.json`; a.click();
    }
    function importData(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) { try { let imp = JSON.parse(e.target.result); if(Array.isArray(imp)){ data = migrate(imp); save(); alert("å·²æˆåŠŸè®€å–é›²ç«¯å‚™ä»½ç´€éŒ„ï¼"); } } catch(err) { alert("æª”æ¡ˆè®€å–å¤±æ•—"); } };
        reader.readAsText(file);
    }
    function resetAll() { if(confirm("ç¢ºå®šè¦é‡ç½®æ­¸é›¶å—ï¼Ÿ")) { data.forEach(c => c.cards.forEach(cd => cd.spent = 0)); save(); } }
    function autoFill(name) { for(let cat of data) for(let card of cat.cards) if(card.name.trim() === name.trim()){ const tCon = document.getElementById('tCon'); tCon.innerHTML = ''; card.tiers.forEach(t => addTierUI(t.rate, t.limit)); return; } }

    load();
</script>
</body>
</html>
